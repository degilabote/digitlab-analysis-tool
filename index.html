<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¸ãƒ©ãƒœãƒ¦ãƒ‹ãƒƒãƒˆæ‰•å‡ºã—ç¥¨åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .upload-area { background: white; border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 30px; }
        .upload-area.drag-over { border-color: #007bff; background: #f0f8ff; }
        .file-input { display: none; }
        .upload-btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .upload-btn:hover { background: #0056b3; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .card .value { font-size: 24px; font-weight: bold; color: #007bff; }
        .quota-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .quota-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .quota-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .quota-card h4 { margin-bottom: 15px; color: #333; }
        .progress-bar { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .progress-green { background: #28a745; }
        .progress-yellow { background: #ffc107; }
        .progress-red { background: #dc3545; }
        .individual-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .individual-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .month-detail { margin-bottom: 15px; font-size: 12px; }
        .month-progress { width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; margin: 5px 0; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-container h3 { margin-bottom: 20px; color: #333; }
        .chart-container canvas { max-height: 350px; }
        .data-table { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .text-red { color: #dc3545; }
        .text-blue { color: #007bff; }
        .text-green { color: #28a745; }
        .text-purple { color: #6f42c1; }
        .text-orange { color: #fd7e14; }
        .text-teal { color: #20c997; }
        @media (max-width: 768px) {
            .charts-section { grid-template-columns: 1fr; }
            .summary-cards { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãƒ‡ã‚¸ãƒ©ãƒœãƒ¦ãƒ‹ãƒƒãƒˆæ‰•å‡ºã—ç¥¨åˆ†æ</h1>
            <p>Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
            <div>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    ğŸ“ Excel/CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
                <p style="margin: 15px 0; color: #666;">ã¾ãŸã¯</p>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="spreadsheetUrl" placeholder="Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›" 
                           style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                    <button class="upload-btn" onclick="loadFromSpreadsheet()" style="background: #34a853;">
                        ğŸ”— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
                    </button>
                </div>
                <button class="upload-btn" onclick="loadFromGoogleAppsScript()" style="background: #ea4335;">
                    ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æº
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    Excelï¼ˆ.xlsxï¼‰ã€CSVï¼ˆ.csvï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ<br>
                    ã¾ãŸã¯ã€ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„<br>
                    <strong>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æºã‚‚å¯èƒ½ï¼</strong>
                </p>
            </div>
        </div>

        <div id="realtimeStatus" style="display: none; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 5px; padding: 15px; margin: 20px 0;">
            <h4 style="color: #2e7d32; margin: 0 0 10px 0;">ğŸ”— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºä¸­</h4>
            <p style="margin: 0 0 10px 0; color: #2e7d32;" id="connectionInfo">æ¥ç¶šæ¸ˆã¿</p>
            
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button onclick="manualUpdate()" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    ğŸ”„ æ‰‹å‹•æ›´æ–°
                </button>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="autoUpdateToggle" onchange="toggleAutoUpdate()">
                    è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                </label>
                <select id="updateInterval" onchange="updateAutoUpdateInterval()" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="300000">5åˆ†ã”ã¨</option>
                    <option value="900000">15åˆ†ã”ã¨</option>
                    <option value="1800000">30åˆ†ã”ã¨</option>
                    <option value="3600000" selected>1æ™‚é–“ã”ã¨</option>
                    <option value="21600000">6æ™‚é–“ã”ã¨</option>
                    <option value="86400000">24æ™‚é–“ã”ã¨</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="stopRealtime()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                    æ¥ç¶šè§£é™¤
                </button>
                <span id="lastUpdateTime" style="font-size: 12px; color: #666; line-height: 2;"></span>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">èª­ã¿è¾¼ã¿ä¸­...</div>

        <div id="results" style="display: none;">
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards">
                <div class="card">
                    <h3>ç·é‡‘é¡</h3>
                    <div class="value" id="totalAmount">Â¥0</div>
                </div>
                <div class="card">
                    <h3>ç·ä»¶æ•°</h3>
                    <div class="value" id="totalCount">0ä»¶</div>
                </div>
                <div class="card">
                    <h3>ç”³è«‹è€…æ•°</h3>
                    <div class="value" id="userCount">0å</div>
                </div>
                <div class="card">
                    <h3>å¤–éƒ¨ç™ºæ³¨</h3>
                    <div class="value text-red" id="externalAmount">Â¥0</div>
                </div>
                <div class="card">
                    <h3>ãƒ‡ã‚¸ãƒ©ãƒœå®Ÿç¸¾</h3>
                    <div class="value text-blue" id="digitalLabAmount">Â¥0</div>
                    <small id="digitalLabAverage">æœˆå¹³å‡: Â¥0</small>
                </div>
            </div>

            <!-- ãƒ‡ã‚¸ãƒ©ãƒœãƒãƒ«ãƒé”æˆçŠ¶æ³ -->
            <div class="quota-section">
                <h2>ğŸ“Š ãƒ‡ã‚¸ãƒ©ãƒœæœˆåˆ¥ãƒãƒ«ãƒé”æˆçŠ¶æ³ï¼ˆæœˆãƒãƒ«ãƒ: Â¥3,400,000ï¼‰</h2>
                <div class="quota-grid" id="quotaGrid"></div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <h4>4ãƒ¶æœˆç·å®Ÿç¸¾</h4>
                            <div style="font-size: 20px; font-weight: bold; color: #007bff;" id="totalDigitalLab">Â¥0</div>
                        </div>
                        <div>
                            <h4>4ãƒ¶æœˆç·ãƒãƒ«ãƒ</h4>
                            <div style="font-size: 20px; font-weight: bold;">Â¥13,600,000</div>
                        </div>
                        <div>
                            <h4>å…¨ä½“é”æˆç‡</h4>
                            <div style="font-size: 20px; font-weight: bold;" id="overallAchievement">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€‹äººåˆ¥ç›®æ¨™é”æˆçŠ¶æ³ -->
            <div class="quota-section">
                <h2>ğŸ‘¤ å€‹äººåˆ¥æœˆé¡ç›®æ¨™é”æˆçŠ¶æ³</h2>
                <div class="individual-grid" id="individualGrid"></div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="filters">
                <h3>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>ç”³è«‹è€…</label>
                        <select id="userFilter">
                            <option value="å…¨å“¡">å…¨å“¡</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>æœˆ</label>
                        <select id="monthFilter">
                            <option value="å…¨æœˆ">å…¨æœˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
                        <select id="titleFilter">
                            <option value="å…¨ã‚¿ã‚¤ãƒˆãƒ«">å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç™ºæ³¨åŒºåˆ†</label>
                        <select id="orderTypeFilter">
                            <option value="å…¨åŒºåˆ†">å…¨åŒºåˆ†</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="charts-section">
                <div class="chart-container">
                    <h3>ç”³è«‹è€…åˆ¥é‡‘é¡</h3>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>ç™ºæ³¨åŒºåˆ†åˆ¥å‰²åˆ</h3>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="data-table">
                <h3>ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ç”³è«‹è€…</th>
                                <th>é‡‘é¡</th>
                                <th>æ‘˜è¦</th>
                                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>ç™ºæ³¨åŒºåˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
                <p id="tableInfo" style="margin-top: 10px; color: #666; font-size: 14px;"></p>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let rawData = [];
        let processedData = [];
        let summary = {};
        let barChart, pieChart;
        let realtimeInterval;
        let googleAppsScriptUrl = 'https://script.google.com/macros/s/AKfycbysACXGzG-04hpQjIuTrSk0MIVLTPw9uWnWeGb-Z3yxSVcdsEYdSLNZ9VOknja4sWQ/exec'; // äº‹å‰è¨­å®šæ¸ˆã¿

        // å€‹äººåˆ¥æœˆé¡ç›®æ¨™
        const INDIVIDUAL_TARGETS = {
            'å‘ã€€å…‹æ˜': 500000,
            'å¾Œè—¤ã€€å’Œå…¸': 1000000,
            'ä¸€æœ¨ã€€ç´€äºŒ': 750000,
            'ä½ã€…æœ¨ã€€ç¿”æ¢§': 600000,
            'å‚æœ¬ã€€è–å¼¥': 500000,
            'å°æ± ã€€å¹¸å¸': 250000
        };

        const MONTHLY_QUOTA = 3400000;

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            showLoading();
            hideError();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // CSVå‡¦ç†
                        rawData = parseCSV(data);
                    } else {
                        // Excelå‡¦ç†
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        rawData = XLSX.utils.sheet_to_json(worksheet);
                    }
                    
                    processData();
                    createSummary();
                    updateDisplay();
                    hideLoading();
                    showResults();
                } catch (error) {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    hideLoading();
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    if (values[index] !== undefined) {
                        // æ•°å€¤ã®å ´åˆã¯å¤‰æ›
                        if (header === 'ç¨è¾¼é‡‘é¡' && !isNaN(parseFloat(values[index]))) {
                            row[header] = parseFloat(values[index]);
                        } else {
                            row[header] = values[index];
                        }
                    }
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿
        async function loadFromSpreadsheet() {
            const url = document.getElementById('spreadsheetUrl').value.trim();
            if (!url) {
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                showLoading();
                hideError();

                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‹ã‚‰CSVå½¢å¼ã§å–å¾—
                let csvUrl;
                if (url.includes('/edit')) {
                    // é€šå¸¸ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL
                    const spreadsheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)[1];
                    csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                } else {
                    showError('æ­£ã—ã„Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    hideLoading();
                    return;
                }

                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                const csvText = await response.text();
                rawData = parseCSV(csvText);
                
                processData();
                createSummary();
                updateDisplay();
                hideLoading();
                showResults();
                
                showError('', 'success', 'âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
                
            } catch (error) {
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                hideLoading();
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶š
        async function connectToDefaultSpreadsheet() {
            try {
                document.getElementById('uploadArea').style.display = 'none';
                await fetchFromGoogleAppsScript();
                setupConnection();
                showError('', 'success', 'âœ… ãƒ‡ã‚¸ãƒ©ãƒœã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã—ãŸ');
            } catch (error) {
                document.getElementById('uploadArea').style.display = 'block';
                showError('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯åˆ¥ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
        window.addEventListener('load', async function() {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€è‡ªå‹•æ¥ç¶šã‚’é–‹å§‹...');
            console.log('ä½¿ç”¨URL:', googleAppsScriptUrl);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è‡ªå‹•æ¥ç¶šã‚’è©¦è¡Œ
            try {
                await fetchFromGoogleAppsScript();
                setupConnection();
                document.getElementById('uploadArea').style.display = 'none';
                showError('', 'success', 'âœ… ãƒ‡ã‚¸ãƒ©ãƒœã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•æ¥ç¶šã—ã¾ã—ãŸ');
                console.log('è‡ªå‹•æ¥ç¶šæˆåŠŸ');
            } catch (error) {
                // è‡ªå‹•æ¥ç¶šã«å¤±æ•—ã—ãŸå ´åˆã¯é€šå¸¸ã®ç”»é¢ã‚’è¡¨ç¤º
                console.error('è‡ªå‹•æ¥ç¶šå¤±æ•—:', error);
                showError('è‡ªå‹•æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '\n\næ‰‹å‹•ã§ã€ŒğŸš€ ãƒ‡ã‚¸ãƒ©ãƒœåˆ†æã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLå…¥åŠ›æ¬„ã®è¡¨ç¤º
        function showSpreadsheetUrlInput() {
            const area = document.getElementById('customSpreadsheetArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        // æ‰‹å‹•æ›´æ–°
        async function manualUpdate() {
            if (!googleAppsScriptUrl) {
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                await fetchFromGoogleAppsScript();
                showError('', 'success', 'âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                updateLastUpdateTime();
            } catch (error) {
                showError('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // æ¥ç¶šè¨­å®š
        function setupConnection() {
            document.getElementById('realtimeStatus').style.display = 'block';
            document.getElementById('autoUpdateToggle').checked = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ‰‹å‹•æ›´æ–°
            updateConnectionInfo();
            updateLastUpdateTime();
        }

        // è‡ªå‹•æ›´æ–°ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoUpdate() {
            const isEnabled = document.getElementById('autoUpdateToggle').checked;
            
            if (isEnabled) {
                startRealtime();
            } else {
                stopAutoUpdate();
            }
            
            updateConnectionInfo();
        }

        // è‡ªå‹•æ›´æ–°é–“éš”ã®å¤‰æ›´
        function updateAutoUpdateInterval() {
            const isAutoEnabled = document.getElementById('autoUpdateToggle').checked;
            if (isAutoEnabled) {
                stopAutoUpdate();
                startRealtime();
            }
        }

        // æ¥ç¶šæƒ…å ±ã®æ›´æ–°
        function updateConnectionInfo() {
            const isAutoEnabled = document.getElementById('autoUpdateToggle').checked;
            const interval = document.getElementById('updateInterval').value;
            const intervalText = document.getElementById('updateInterval').selectedOptions[0].text;
            
            const infoElement = document.getElementById('connectionInfo');
            if (isAutoEnabled) {
                infoElement.textContent = `è‡ªå‹•æ›´æ–°ä¸­ï¼ˆ${intervalText}ï¼‰`;
                infoElement.style.color = '#2e7d32';
            } else {
                infoElement.textContent = 'æ‰‹å‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰';
                infoElement.style.color = '#1976d2';
            }
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã®è¡¨ç¤º
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP');
            document.getElementById('lastUpdateTime').textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
        }

        function fetchFromGoogleAppsScript() {
            return new Promise((resolve, reject) => {
                if (!googleAppsScriptUrl) {
                    reject(new Error('Google Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'));
                    return;
                }

                showLoading();
                hideError();

                // JSONPç”¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°åã‚’ç”Ÿæˆ
                const callbackName = 'jsonp_callback_' + Date.now();
                let script; // ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é–¢æ•°å…¨ä½“ã«æ‹¡å¼µ
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©
                window[callbackName] = function(result) {
                    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’å‰Šé™¤
                    if (script && document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                    
                    console.log('Google Apps Script ã‹ã‚‰ã®å¿œç­”:', result);
                    
                    try {
                        if (result.success) {
                            rawData = result.data;
                            processData();
                            createSummary();
                            updateDisplay();
                            hideLoading();
                            showResults();
                            
                            resolve(result);
                        } else {
                            throw new Error(`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}\nè©³ç´°: ${result.message || 'ãªã—'}`);
                        }
                    } catch (error) {
                        hideLoading();
                        reject(error);
                    }
                };

                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’ä½œæˆã—ã¦JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                script = document.createElement('script');
                script.src = `${googleAppsScriptUrl}?callback=${callbackName}`;
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                script.onerror = function() {
                    if (script && document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                    hideLoading();
                    reject(new Error(
                        'Google Apps Script ã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n' +
                        'è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :\n' +
                        '1. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã®å•é¡Œ\n' +
                        '2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™\n' +
                        '3. Apps Script ã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š\n\n' +
                        'ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                    ));
                };
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ15ç§’ï¼‰
                setTimeout(() => {
                    if (script && document.head.contains(script)) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        hideLoading();
                        reject(new Error(
                            'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: Google Apps Script ã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\n' +
                            'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã‚’ç¢ºèªã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                        ));
                    }
                }, 15000);
                
                // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’DOMã«è¿½åŠ 
                document.head.appendChild(script);
            });
        }

        function startRealtime() {
            // æ—¢å­˜ã®è‡ªå‹•æ›´æ–°ã‚’åœæ­¢
            stopAutoUpdate();
            
            // é¸æŠã•ã‚ŒãŸé–“éš”ã‚’å–å¾—
            const interval = parseInt(document.getElementById('updateInterval').value);
            
            // è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
            realtimeInterval = setInterval(() => {
                fetchFromGoogleAppsScript()
                    .then(() => {
                        console.log('è‡ªå‹•æ›´æ–°å®Œäº†:', new Date().toLocaleTimeString());
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        console.error('è‡ªå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                        showError('è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    });
            }, interval);
            
            console.log(`è‡ªå‹•æ›´æ–°é–‹å§‹: ${interval / 1000 / 60}åˆ†é–“éš”`);
        }

        function stopAutoUpdate() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        function stopRealtime() {
            stopAutoUpdate();
            document.getElementById('realtimeStatus').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('autoUpdateToggle').checked = false;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å ´åˆã¯å®Œå…¨ã«åˆ‡æ–­ã—ãªã„
            if (googleAppsScriptUrl !== 'https://script.google.com/macros/s/AKfycbysACXGzG-04hpQjIuTrSk0MIVLTPw9uWnWeGb-Z3yxSVcdsEYdSLNZ9VOknja4sWQ/exec') {
                googleAppsScriptUrl = '';
            }
        }

        function processData() {
            processedData = rawData.map((row, index) => {
                let date = null;
                const dateField = row['ç”³è«‹æ—¥'];
                
                if (dateField) {
                    if (typeof dateField === 'number') {
                        date = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        date = new Date(dateField);
                    }
                }

                return {
                    id: index,
                    date: date,
                    month: date ? `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ` : 'ä¸æ˜',
                    applicant: row['ç”³è«‹è€…'] || 'ä¸æ˜',
                    amount: parseFloat(row['ç¨è¾¼é‡‘é¡'] || 0),
                    summary: row['æ‘˜è¦'] || 'ä¸æ˜',
                    title: row['ã‚¿ã‚¤ãƒˆãƒ«'] || 'ä¸æ˜',
                    orderType: row['ç™ºæ³¨åŒºåˆ†'] || 'ä¸æ˜'
                };
            });
        }

        function createSummary() {
            const userSummary = {};
            const monthSummary = {};
            const orderTypeSummary = {};
            const titleSummary = {};

            processedData.forEach(item => {
                // ç”³è«‹è€…åˆ¥
                if (!userSummary[item.applicant]) {
                    userSummary[item.applicant] = { 
                        total: 0, 
                        months: {}, 
                        orderTypes: {},
                        titles: {}
                    };
                }
                userSummary[item.applicant].total += item.amount;

                // æœˆåˆ¥
                if (!userSummary[item.applicant].months[item.month]) {
                    userSummary[item.applicant].months[item.month] = 0;
                }
                userSummary[item.applicant].months[item.month] += item.amount;

                // ç™ºæ³¨åŒºåˆ†åˆ¥
                if (!userSummary[item.applicant].orderTypes[item.orderType]) {
                    userSummary[item.applicant].orderTypes[item.orderType] = 0;
                }
                userSummary[item.applicant].orderTypes[item.orderType] += item.amount;

                // å…¨ä½“é›†è¨ˆ
                if (!monthSummary[item.month]) {
                    monthSummary[item.month] = 0;
                }
                monthSummary[item.month] += item.amount;

                if (!orderTypeSummary[item.orderType]) {
                    orderTypeSummary[item.orderType] = 0;
                }
                orderTypeSummary[item.orderType] += item.amount;

                if (!titleSummary[item.title]) {
                    titleSummary[item.title] = 0;
                }
                titleSummary[item.title] += item.amount;
            });

            summary = {
                users: userSummary,
                months: monthSummary,
                orderTypes: orderTypeSummary,
                titles: titleSummary,
                totalAmount: processedData.reduce((sum, item) => sum + item.amount, 0),
                totalCount: processedData.length
            };
        }

        function updateDisplay() {
            updateSummaryCards();
            updateQuotaSection();
            updateIndividualSection();
            updateFilters();
            updateCharts();
            updateDataTable();
        }

        function updateSummaryCards() {
            const digitalLabAmount = summary.totalAmount - (summary.orderTypes['é–‹ç™º'] || 0) * 2;
            
            document.getElementById('totalAmount').textContent = 'Â¥' + summary.totalAmount.toLocaleString();
            document.getElementById('totalCount').textContent = summary.totalCount + 'ä»¶';
            document.getElementById('userCount').textContent = Object.keys(summary.users).length + 'å';
            document.getElementById('externalAmount').textContent = 'Â¥' + (summary.orderTypes['å¤–éƒ¨ç™ºæ³¨'] || 0).toLocaleString();
            document.getElementById('digitalLabAmount').textContent = 'Â¥' + digitalLabAmount.toLocaleString();
            document.getElementById('digitalLabAverage').textContent = 'æœˆå¹³å‡: Â¥' + Math.round(digitalLabAmount / 4).toLocaleString();
        }

        function updateQuotaSection() {
            const digitalLabMonthly = calculateDigitalLabMonthly();
            const quotaGrid = document.getElementById('quotaGrid');
            quotaGrid.innerHTML = '';

            digitalLabMonthly.forEach(monthData => {
                const card = document.createElement('div');
                card.className = 'quota-card';
                
                const progressClass = monthData.achievementRate >= 100 ? 'progress-green' : 
                                    monthData.achievementRate >= 80 ? 'progress-yellow' : 'progress-red';
                const statusIcon = monthData.achievementRate >= 100 ? 'âœ…' : 
                                 monthData.achievementRate >= 80 ? 'âš ï¸' : 'âŒ';

                card.innerHTML = `
                    <h4>${monthData.month}</h4>
                    <div style="font-size: 18px; font-weight: bold; color: #007bff; margin-bottom: 10px;">
                        Â¥${monthData.amount.toLocaleString()}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ãƒãƒ«ãƒ: Â¥${monthData.quota.toLocaleString()}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${Math.min(monthData.achievementRate, 100)}%"></div>
                    </div>
                    <div style="font-weight: bold; margin-top: 5px;">
                        ${monthData.achievementRate.toFixed(1)}% ${statusIcon}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: ${monthData.difference >= 0 ? '#28a745' : '#dc3545'};">
                        ${monthData.difference >= 0 ? '+' : ''}Â¥${monthData.difference.toLocaleString()}
                    </div>
                `;
                quotaGrid.appendChild(card);
            });

            // å…¨ä½“é”æˆç‡æ›´æ–°
            const totalDigitalLab = summary.totalAmount - (summary.orderTypes['é–‹ç™º'] || 0) * 2;
            const overallRate = (totalDigitalLab / (MONTHLY_QUOTA * 4)) * 100;
            
            document.getElementById('totalDigitalLab').textContent = 'Â¥' + totalDigitalLab.toLocaleString();
            document.getElementById('overallAchievement').textContent = overallRate.toFixed(1) + '%';
            document.getElementById('overallAchievement').style.color = 
                overallRate >= 100 ? '#28a745' : overallRate >= 80 ? '#ffc107' : '#dc3545';
        }

        function updateIndividualSection() {
            const individualMonthly = calculateIndividualMonthly();
            const individualGrid = document.getElementById('individualGrid');
            individualGrid.innerHTML = '';

            Object.entries(individualMonthly).forEach(([applicant, data]) => {
                const card = document.createElement('div');
                card.className = 'individual-card';

                let monthsHtml = '';
                data.months.forEach(monthData => {
                    const progressClass = monthData.achievementRate >= 100 ? 'progress-green' : 
                                        monthData.achievementRate >= 80 ? 'progress-yellow' : 'progress-red';
                    
                    monthsHtml += `
                        <div class="month-detail">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 500;">${monthData.month}</span>
                                <span style="color: ${monthData.achievementRate >= 100 ? '#28a745' : monthData.achievementRate >= 80 ? '#ffc107' : '#dc3545'};">
                                    ${monthData.achievementRate.toFixed(0)}%
                                </span>
                            </div>
                            <div class="month-progress">
                                <div class="progress-fill ${progressClass}" style="width: ${Math.min(monthData.achievementRate, 100)}%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666;">
                                <span>Â¥${monthData.amount.toLocaleString()}</span>
                                <span style="color: ${monthData.difference >= 0 ? '#28a745' : '#dc3545'};">
                                    ${monthData.difference >= 0 ? '+' : ''}Â¥${monthData.difference.toLocaleString()}
                                </span>
                            </div>
                        </div>
                    `;
                });

                const overallColor = data.overallAchievementRate >= 100 ? '#28a745' : 
                                   data.overallAchievementRate >= 80 ? '#ffc107' : '#dc3545';
                const overallIcon = data.overallAchievementRate >= 100 ? 'âœ…' : 
                                  data.overallAchievementRate >= 80 ? 'âš ï¸' : 'âŒ';

                card.innerHTML = `
                    <h4 style="margin-bottom: 15px; color: #333;">${applicant}</h4>
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #666;">æœˆç›®æ¨™: Â¥${data.target.toLocaleString()}</div>
                        <div style="font-size: 14px; font-weight: 500; color: #007bff;">4ãƒ¶æœˆå®Ÿç¸¾: Â¥${data.totalAmount.toLocaleString()}</div>
                        <div style="font-size: 14px; font-weight: bold; color: ${overallColor};">
                            å…¨ä½“é”æˆç‡: ${data.overallAchievementRate.toFixed(1)}% ${overallIcon}
                        </div>
                    </div>
                    ${monthsHtml}
                `;
                individualGrid.appendChild(card);
            });
        }

        function calculateDigitalLabMonthly() {
            const monthlyData = {};
            
            processedData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = 0;
                }
                if (item.orderType === 'é–‹ç™º') {
                    monthlyData[item.month] -= item.amount;
                } else {
                    monthlyData[item.month] += item.amount;
                }
            });

            // æœˆã‚’æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedMonths = Object.entries(monthlyData).sort(([monthA], [monthB]) => {
                const getMonthNumber = (monthStr) => {
                    const match = monthStr.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                    if (match) {
                        return parseInt(match[1]) * 100 + parseInt(match[2]);
                    }
                    return 0;
                };
                return getMonthNumber(monthA) - getMonthNumber(monthB);
            });

            return sortedMonths.map(([month, amount]) => ({
                month,
                amount,
                quota: MONTHLY_QUOTA,
                achievementRate: (amount / MONTHLY_QUOTA) * 100,
                difference: amount - MONTHLY_QUOTA
            }));
        }

        function calculateIndividualMonthly() {
            const individualData = {};
            
            processedData.forEach(item => {
                if (!individualData[item.applicant]) {
                    individualData[item.applicant] = {};
                }
                if (!individualData[item.applicant][item.month]) {
                    individualData[item.applicant][item.month] = 0;
                }
                
                if (item.orderType === 'é–‹ç™º') {
                    individualData[item.applicant][item.month] -= item.amount;
                } else {
                    individualData[item.applicant][item.month] += item.amount;
                }
            });

            const result = {};
            Object.entries(individualData).forEach(([applicant, months]) => {
                const target = INDIVIDUAL_TARGETS[applicant] || 0;
                
                // æœˆã‚’æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedMonths = Object.entries(months).sort(([monthA], [monthB]) => {
                    // "2025å¹´4æœˆ" ã®ã‚ˆã†ãªå½¢å¼ã‚’æ¯”è¼ƒç”¨ã®æ•°å€¤ã«å¤‰æ›
                    const getMonthNumber = (monthStr) => {
                        const match = monthStr.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (match) {
                            return parseInt(match[1]) * 100 + parseInt(match[2]);
                        }
                        return 0;
                    };
                    return getMonthNumber(monthA) - getMonthNumber(monthB);
                });

                result[applicant] = {
                    target,
                    months: sortedMonths.map(([month, amount]) => ({
                        month,
                        amount,
                        target,
                        achievementRate: target > 0 ? (amount / target) * 100 : 0,
                        difference: amount - target
                    })),
                    totalAmount: Object.values(months).reduce((sum, amount) => sum + amount, 0),
                    totalTarget: target * 4,
                    overallAchievementRate: target > 0 ? (Object.values(months).reduce((sum, amount) => sum + amount, 0) / (target * 4)) * 100 : 0
                };
            });

            return result;
        }

        function updateFilters() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°å‡¦ç†
            const userFilter = document.getElementById('userFilter');
            const monthFilter = document.getElementById('monthFilter');
            const titleFilter = document.getElementById('titleFilter');
            const orderTypeFilter = document.getElementById('orderTypeFilter');

            userFilter.innerHTML = '<option value="å…¨å“¡">å…¨å“¡</option>';
            Object.keys(summary.users).forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });

            monthFilter.innerHTML = '<option value="å…¨æœˆ">å…¨æœˆ</option>';
            Object.keys(summary.months).sort().forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });

            titleFilter.innerHTML = '<option value="å…¨ã‚¿ã‚¤ãƒˆãƒ«">å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>';
            Object.keys(summary.titles).sort().forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                titleFilter.appendChild(option);
            });

            orderTypeFilter.innerHTML = '<option value="å…¨åŒºåˆ†">å…¨åŒºåˆ†</option>';
            Object.keys(summary.orderTypes).sort().forEach(orderType => {
                const option = document.createElement('option');
                option.value = orderType;
                option.textContent = orderType;
                orderTypeFilter.appendChild(option);
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            [userFilter, monthFilter, titleFilter, orderTypeFilter].forEach(filter => {
                filter.addEventListener('change', () => {
                    updateCharts();
                    updateDataTable();
                });
            });
        }

        function getFilteredData() {
            const userFilter = document.getElementById('userFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const titleFilter = document.getElementById('titleFilter').value;
            const orderTypeFilter = document.getElementById('orderTypeFilter').value;

            return processedData.filter(item => {
                const userMatch = userFilter === 'å…¨å“¡' || item.applicant === userFilter;
                const monthMatch = monthFilter === 'å…¨æœˆ' || item.month === monthFilter;
                const titleMatch = titleFilter === 'å…¨ã‚¿ã‚¤ãƒˆãƒ«' || item.title === titleFilter;
                const orderTypeMatch = orderTypeFilter === 'å…¨åŒºåˆ†' || item.orderType === orderTypeFilter;
                return userMatch && monthMatch && titleMatch && orderTypeMatch;
            });
        }

        function updateCharts() {
            updateBarChart();
            updatePieChart();
        }

        function updateBarChart() {
            const filtered = getFilteredData();
            const userData = {};
            
            filtered.forEach(item => {
                if (!userData[item.applicant]) {
                    userData[item.applicant] = 0;
                }
                userData[item.applicant] += item.amount;
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚’é‡‘é¡ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
            const sortedData = Object.entries(userData)
                .sort(([,a], [,b]) => b - a);
            
            const labels = sortedData.map(([name]) => name);
            const data = sortedData.map(([,amount]) => amount);

            if (barChart) {
                barChart.destroy();
            }

            const ctx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‡‘é¡',
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePieChart() {
            const filtered = getFilteredData();
            const orderTypeData = {};
            
            filtered.forEach(item => {
                if (!orderTypeData[item.orderType]) {
                    orderTypeData[item.orderType] = 0;
                }
                orderTypeData[item.orderType] += item.amount;
            });

            const labels = Object.keys(orderTypeData);
            const data = Object.values(orderTypeData);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#36A2EB'
            ];

            if (pieChart) {
                pieChart.destroy();
            }

            const ctx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': Â¥' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDataTable() {
            const filtered = getFilteredData();
            const tbody = document.getElementById('dataTableBody');
            const tableInfo = document.getElementById('tableInfo');
            
            tbody.innerHTML = '';
            
            // æœ€åˆã®50ä»¶ã®ã¿è¡¨ç¤º
            const displayData = filtered.slice(0, 50);
            
            displayData.forEach((item, index) => {
                const row = document.createElement('tr');
                const orderTypeClass = getOrderTypeClass(item.orderType);
                
                row.innerHTML = `
                    <td>${item.month}</td>
                    <td>${item.applicant}</td>
                    <td style="text-align: right; ${item.amount < 0 ? 'color: #dc3545;' : ''}">
                        Â¥${item.amount.toLocaleString()}
                    </td>
                    <td>${item.summary}</td>
                    <td>${item.title}</td>
                    <td style="text-align: center; font-weight: bold;" class="${orderTypeClass}">
                        ${item.orderType}
                    </td>
                `;
                tbody.appendChild(row);
            });

            tableInfo.textContent = filtered.length > 50 ? 
                `æœ€åˆã®50ä»¶ã‚’è¡¨ç¤ºä¸­ï¼ˆå…¨${filtered.length}ä»¶ï¼‰` : 
                `å…¨${filtered.length}ä»¶ã‚’è¡¨ç¤º`;
        }

        function getOrderTypeClass(orderType) {
            switch(orderType) {
                case 'å¤–éƒ¨ç™ºæ³¨': return 'text-red';
                case 'ç¤¾å†…': return 'text-blue';
                case 'ãƒ‡ã‚¸ãƒ©ãƒœ': return 'text-green';
                case 'é–‹ç™º': return 'text-purple';
                case 'å€¤å¼•ã': return 'text-orange';
                case 'ï¼°ç²—åˆ©å®Ÿç¸¾': return 'text-teal';
                default: return '';
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message, type = 'error', customMessage = '') {
            const errorDiv = document.getElementById('error');
            if (customMessage) {
                errorDiv.innerHTML = customMessage;
                errorDiv.className = 'error';
                errorDiv.style.background = '#d4edda';
                errorDiv.style.color = '#155724';
                errorDiv.style.border = '1px solid #c3e6cb';
            } else if (message) {
                errorDiv.textContent = message;
                errorDiv.className = 'error';
                errorDiv.style.background = '#f8d7da';
                errorDiv.style.color = '#721c24';
                errorDiv.style.border = '1px solid #f5c6cb';
            }
            errorDiv.style.display = message || customMessage ? 'block' : 'none';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>