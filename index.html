<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¸ãƒ©ãƒœãƒ¦ãƒ‹ãƒƒãƒˆæ‰•å‡ºã—ç¥¨åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
        .upload-area { background: white; border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 30px; }
        .upload-area.drag-over { border-color: #007bff; background: #f0f8ff; }
        .file-input { display: none; }
        .upload-btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .upload-btn:hover { background: #0056b3; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .card .value { font-size: 24px; font-weight: bold; color: #007bff; }
        .quota-section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .quota-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .quota-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .quota-card h4 { margin-bottom: 15px; color: #333; }
        .progress-bar { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .progress-green { background: #28a745; }
        .progress-yellow { background: #ffc107; }
        .progress-red { background: #dc3545; }
        .individual-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .individual-card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .month-detail { margin-bottom: 15px; font-size: 12px; }
        .month-progress { width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; margin: 5px 0; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chart-container h3 { margin-bottom: 20px; color: #333; }
        .chart-container canvas { max-height: 350px; }
        .data-table { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .table tr:hover { background: #f8f9fa; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .text-red { color: #dc3545; }
        .text-blue { color: #007bff; }
        .text-green { color: #28a745; }
        .text-purple { color: #6f42c1; }
        .text-orange { color: #fd7e14; }
        .text-teal { color: #20c997; }
        
        /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .pagination-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #0056b3;
        }
        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .charts-section { grid-template-columns: 1fr; }
            .summary-cards { grid-template-columns: 1fr 1fr; }
            #pagination {
                flex-wrap: wrap;
                gap: 5px;
            }
            .pagination-btn {
                padding: 6px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ãƒ‡ã‚¸ãƒ©ãƒœãƒ¦ãƒ‹ãƒƒãƒˆæ‰•å‡ºã—ç¥¨åˆ†æ</h1>
            <p>Excel ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
            <div>
                <div id="defaultConnectionArea">
                    <button class="upload-btn" onclick="loadFromDefaultSpreadsheet()" style="background: #34a853; font-size: 18px; padding: 15px 30px;">
                        ğŸš€ ãƒ‡ã‚¸ãƒ©ãƒœã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
                    </button>
                    <p style="margin: 15px 0; color: #666; font-weight: bold;">
                        â†‘ ã‚¯ãƒªãƒƒã‚¯ã§æœ€æ–°ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    </p>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">ğŸ“Š ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()" style="background: #6c757d;">
                            ğŸ“ Excel/CSV ãƒ•ã‚¡ã‚¤ãƒ«
                        </button>
                        <button class="upload-btn" onclick="showSpreadsheetUrlInput()" style="background: #28a745;">
                            ğŸ”— åˆ¥ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>

                <div id="customSpreadsheetArea" style="display: none; margin: 15px 0;">
                    <input type="text" id="spreadsheetUrl" placeholder="Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›" 
                           style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                    <button class="upload-btn" onclick="loadFromSpreadsheet()" style="background: #34a853;">
                        ğŸ”— èª­ã¿è¾¼ã¿
                    </button>
                </div>

                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                    Excelï¼ˆ.xlsxï¼‰ã€CSVï¼ˆ.csvï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«å¯¾å¿œ
                </p>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">èª­ã¿è¾¼ã¿ä¸­...</div>

        <div id="results" style="display: none;">
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards">
                <div class="card">
                    <h3>ç·é‡‘é¡</h3>
                    <div class="value" id="totalAmount">Â¥0</div>
                </div>
                <div class="card">
                    <h3>ç·ä»¶æ•°</h3>
                    <div class="value" id="totalCount">0ä»¶</div>
                </div>
                <div class="card">
                    <h3>ç”³è«‹è€…æ•°</h3>
                    <div class="value" id="userCount">0å</div>
                </div>
                <div class="card">
                    <h3>å¤–éƒ¨ç™ºæ³¨</h3>
                    <div class="value text-red" id="externalAmount">Â¥0</div>
                </div>
                <div class="card">
                    <h3>ãƒ‡ã‚¸ãƒ©ãƒœå®Ÿç¸¾</h3>
                    <div class="value text-blue" id="digitalLabAmount">Â¥0</div>
                    <small id="digitalLabAverage">æœˆå¹³å‡: Â¥0</small>
                </div>
            </div>

            <!-- ãƒ‡ã‚¸ãƒ©ãƒœãƒãƒ«ãƒé”æˆçŠ¶æ³ -->
            <div class="quota-section">
                <h2>ğŸ“Š ãƒ‡ã‚¸ãƒ©ãƒœæœˆåˆ¥ãƒãƒ«ãƒé”æˆçŠ¶æ³ï¼ˆæœˆãƒãƒ«ãƒ: Â¥3,400,000ï¼‰</h2>
                <div class="quota-grid" id="quotaGrid"></div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <h4>4ãƒ¶æœˆç·å®Ÿç¸¾</h4>
                            <div style="font-size: 20px; font-weight: bold; color: #007bff;" id="totalDigitalLab">Â¥0</div>
                        </div>
                        <div>
                            <h4>4ãƒ¶æœˆç·ãƒãƒ«ãƒ</h4>
                            <div style="font-size: 20px; font-weight: bold;">Â¥13,600,000</div>
                        </div>
                        <div>
                            <h4>å…¨ä½“é”æˆç‡</h4>
                            <div style="font-size: 20px; font-weight: bold;" id="overallAchievement">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€‹äººåˆ¥ç›®æ¨™é”æˆçŠ¶æ³ -->
            <div class="quota-section">
                <h2>ğŸ‘¤ å€‹äººåˆ¥æœˆé¡ç›®æ¨™é”æˆçŠ¶æ³</h2>
                <div class="individual-grid" id="individualGrid"></div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="filters">
                <h3>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>ç”³è«‹è€…</label>
                        <select id="userFilter">
                            <option value="å…¨å“¡">å…¨å“¡</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>æœˆ</label>
                        <select id="monthFilter">
                            <option value="å…¨æœˆ">å…¨æœˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
                        <select id="titleFilter">
                            <option value="å…¨ã‚¿ã‚¤ãƒˆãƒ«">å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç™ºæ³¨åŒºåˆ†</label>
                        <select id="orderTypeFilter">
                            <option value="å…¨åŒºåˆ†">å…¨åŒºåˆ†</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="charts-section">
                <div class="chart-container">
                    <h3>ç”³è«‹è€…åˆ¥é‡‘é¡</h3>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>ç™ºæ³¨åŒºåˆ†åˆ¥å‰²åˆ</h3>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="data-table">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="itemsPerPage" style="font-size: 14px; color: #666;">è¡¨ç¤ºä»¶æ•°:</label>
                        <select id="itemsPerPage" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="50">50ä»¶</option>
                            <option value="100" selected>100ä»¶</option>
                            <option value="200">200ä»¶</option>
                            <option value="500">500ä»¶</option>
                        </select>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>ç”³è«‹è€…</th>
                                <th>é‡‘é¡</th>
                                <th>æ‘˜è¦</th>
                                <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                                <th>ç™ºæ³¨åŒºåˆ†</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
                
                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                    <button id="firstPage" class="pagination-btn" onclick="goToPage(1)">â‰ª æœ€åˆ</button>
                    <button id="prevPage" class="pagination-btn" onclick="goToPage(currentPage - 1)">â€¹ å‰ã¸</button>
                    <span id="pageInfo" style="margin: 0 15px; font-weight: 500; color: #333;"></span>
                    <button id="nextPage" class="pagination-btn" onclick="goToPage(currentPage + 1)">æ¬¡ã¸ â€º</button>
                    <button id="lastPage" class="pagination-btn" onclick="goToPage(totalPages)">æœ€å¾Œ â‰«</button>
                </div>
                
                <p id="tableInfo" style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;"></p>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let rawData = [];
        let processedData = [];
        let filteredData = [];
        let summary = {};
        let barChart, pieChart;
        let defaultSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1zZTMede6zZe80Sz56BZAqUKtarU0boF17eVqZxTvz30/export?format=csv&gid=1905694608';

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨å¤‰æ•°
        let currentPage = 1;
        let itemsPerPage = 100;
        let totalPages = 1;

        // å€‹äººåˆ¥æœˆé¡ç›®æ¨™
        const INDIVIDUAL_TARGETS = {
            'å‘ã€€å…‹æ˜': 500000,
            'å¾Œè—¤ã€€å’Œå…¸': 1000000,
            'ä¸€æœ¨ã€€ç´€äºŒ': 750000,
            'ä½ã€…æœ¨ã€€ç¿”æ¢§': 600000,
            'å‚æœ¬ã€€è–å¼¥': 500000,
            'å°æ± ã€€å¹¸å¸': 250000
        };

        const MONTHLY_QUOTA = 3400000;

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            showLoading();
            hideError();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        rawData = parseCSVImproved(data);
                    } else {
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        rawData = XLSX.utils.sheet_to_json(worksheet);
                    }
                    
                    processData();
                    createSummary();
                    updateDisplay();
                    hideLoading();
                    showResults();
                    showSuccess('âœ… Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼ˆ' + rawData.length + 'ä»¶ï¼‰');
                } catch (error) {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    hideLoading();
                }
            };
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // æ”¹å–„ã•ã‚ŒãŸCSVè§£æå‡¦ç†
        function parseCSVImproved(csvText) {
            console.log('CSVè§£æé–‹å§‹...');
            
            // Papa Parseã‚’ä½¿ç”¨ã—ãŸå¼·åŒ–ã•ã‚ŒãŸCSVè§£æ
            const result = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false, // å‹å¤‰æ›ã‚’ç„¡åŠ¹ã«ã—ã¦æ‰‹å‹•ã§å‡¦ç†
                encoding: 'UTF-8',
                delimiter: ',',
                quoteChar: '"',
                escapeChar: '"',
                transform: function(value, field) {
                    // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
                    return value ? value.toString().trim() : '';
                }
            });

            console.log('Papa Parseçµæœ:', result);
            console.log('ã‚¨ãƒ©ãƒ¼:', result.errors);
            console.log('ãƒ¡ã‚¿æƒ…å ±:', result.meta);

            if (result.errors.length > 0) {
                console.warn('CSVè§£æè­¦å‘Š:', result.errors);
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•å‡¦ç†ã¨æ¤œè¨¼
            const processedData = result.data.map((row, index) => {
                const processedRow = {};
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæŸ”è»Ÿãªå¯¾å¿œï¼‰
                const headerMap = {
                    'ç”³è«‹æ—¥': ['ç”³è«‹æ—¥', 'ç”³è«‹æ—¥ä»˜', 'date'],
                    'ç”³è«‹è€…': ['ç”³è«‹è€…', 'applicant', 'åå‰'],
                    'ç¨è¾¼é‡‘é¡': ['ç¨è¾¼é‡‘é¡', 'é‡‘é¡', 'amount'],
                    'æ‘˜è¦': ['æ‘˜è¦', 'æ¦‚è¦', 'summary'],
                    'ã‚¿ã‚¤ãƒˆãƒ«': ['ã‚¿ã‚¤ãƒˆãƒ«', 'title', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ'],
                    'ç™ºæ³¨åŒºåˆ†': ['ç™ºæ³¨åŒºåˆ†', 'åŒºåˆ†', 'type']
                };

                Object.keys(headerMap).forEach(standardKey => {
                    const possibleKeys = headerMap[standardKey];
                    let value = '';
                    
                    for (const key of possibleKeys) {
                        if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                            value = row[key];
                            break;
                        }
                    }
                    
                    // ç‰¹åˆ¥ãªå‡¦ç†
                    if (standardKey === 'ç¨è¾¼é‡‘é¡') {
                        // é‡‘é¡ã®å‡¦ç†ï¼šã‚«ãƒ³ãƒã€å††ãƒãƒ¼ã‚¯ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»
                        if (value) {
                            const cleanValue = value.toString().replace(/[,Â¥\så††]/g, '');
                            processedRow[standardKey] = parseFloat(cleanValue) || 0;
                        } else {
                            processedRow[standardKey] = 0;
                        }
                    } else {
                        processedRow[standardKey] = value ? value.toString().trim() : '';
                    }
                });

                return processedRow;
            }).filter(row => {
                // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                return row['ç”³è«‹è€…'] && 
                       row['ç”³è«‹è€…'] !== '' && 
                       row['ç¨è¾¼é‡‘é¡'] !== undefined && 
                       !isNaN(row['ç¨è¾¼é‡‘é¡']);
            });

            console.log('å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', processedData.length);
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', processedData.slice(0, 3));

            return processedData;
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿
        async function loadFromDefaultSpreadsheet() {
            try {
                showLoading();
                hideError();

                console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹...');
                const response = await fetch(defaultSpreadsheetUrl);
                if (!response.ok) {
                    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                const csvText = await response.text();
                console.log('å–å¾—ã—ãŸCSVã®æœ€åˆã®500æ–‡å­—:', csvText.substring(0, 500));
                
                rawData = parseCSVImproved(csvText);
                
                processData();
                createSummary();
                updateDisplay();
                hideLoading();
                showResults();
                
                showSuccess('âœ… ãƒ‡ã‚¸ãƒ©ãƒœã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼ˆ' + rawData.length + 'ä»¶ï¼‰');
                
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                hideLoading();
            }
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿
        async function loadFromSpreadsheet() {
            const url = document.getElementById('spreadsheetUrl').value.trim();
            if (!url) {
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                showLoading();
                hideError();

                let csvUrl;
                if (url.includes('/edit')) {
                    const spreadsheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)[1];
                    let gid = '0';
                    const gidMatch = url.match(/gid=([0-9]+)/);
                    if (gidMatch) {
                        gid = gidMatch[1];
                    }
                    csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=${gid}`;
                } else {
                    showError('æ­£ã—ã„Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    hideLoading();
                    return;
                }

                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                const csvText = await response.text();
                rawData = parseCSVImproved(csvText);
                
                processData();
                createSummary();
                updateDisplay();
                hideLoading();
                showResults();
                
                showSuccess('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼ˆ' + rawData.length + 'ä»¶ï¼‰');
                
            } catch (error) {
                showError('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
                hideLoading();
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLå…¥åŠ›æ¬„ã®è¡¨ç¤º
        function showSpreadsheetUrlInput() {
            const area = document.getElementById('customSpreadsheetArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
        window.addEventListener('load', async function() {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...');
            
            try {
                await loadFromDefaultSpreadsheet();
                console.log('è‡ªå‹•èª­ã¿è¾¼ã¿æˆåŠŸ');
            } catch (error) {
                console.error('è‡ªå‹•èª­ã¿è¾¼ã¿å¤±æ•—:', error);
                showError('è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '\n\næ‰‹å‹•ã§ã€ŒğŸš€ ãƒ‡ã‚¸ãƒ©ãƒœã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        function processData() {
            console.log('ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–‹å§‹...');
            console.log('ç”Ÿãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', rawData.length);

            processedData = rawData.map((row, index) => {
                let date = null;
                const dateField = row['ç”³è«‹æ—¥'];
                
                if (dateField) {
                    if (typeof dateField === 'number') {
                        // Excelã®ã‚·ãƒªã‚¢ãƒ«ç•ªå·ã®å ´åˆ
                        date = new Date((dateField - 25569) * 86400 * 1000);
                    } else if (typeof dateField === 'string') {
                        // æ–‡å­—åˆ—ã®æ—¥ä»˜ã‚’è§£æ
                        if (dateField.includes('/')) {
                            // YYYY/MM/DD å½¢å¼
                            const parts = dateField.split('/');
                            if (parts.length === 3) {
                                const year = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // æœˆã¯0ãƒ™ãƒ¼ã‚¹
                                const day = parseInt(parts[2]);
                                date = new Date(year, month, day);
                            }
                        } else {
                            date = new Date(dateField);
                        }
                    } else if (dateField instanceof Date) {
                        date = dateField;
                    }
                }

                // æœˆã®è¨ˆç®—
                let month = 'ä¸æ˜';
                if (date && !isNaN(date.getTime())) {
                    month = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
                }

                return {
                    id: index,
                    date: date,
                    month: month,
                    applicant: (row['ç”³è«‹è€…'] || '').toString().trim(),
                    amount: row['ç¨è¾¼é‡‘é¡'] || 0,
                    summary: (row['æ‘˜è¦'] || '').toString().trim(),
                    title: (row['ã‚¿ã‚¤ãƒˆãƒ«'] || '').toString().trim(),
                    orderType: (row['ç™ºæ³¨åŒºåˆ†'] || '').toString().trim()
                };
            }).filter(item => {
                // ã‚ˆã‚Šç·©ã„æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const hasApplicant = item.applicant && item.applicant !== '' && item.applicant !== 'ä¸æ˜';
                const hasValidAmount = !isNaN(item.amount) && item.amount !== null;
                const hasValidDate = item.month !== 'ä¸æ˜';
                
                console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°:', {
                    applicant: item.applicant,
                    hasApplicant,
                    amount: item.amount,
                    hasValidAmount,
                    month: item.month,
                    hasValidDate
                });
                
                return hasApplicant && hasValidAmount && hasValidDate;
            });

            console.log('å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', processedData.length);
            
            // ãƒ‡ãƒãƒƒã‚°: å¾Œè—¤ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            const gotoData = processedData.filter(item => 
                item.applicant.includes('å¾Œè—¤') || item.applicant.includes('å’Œå…¸')
            );
            console.log('å¾Œè—¤ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', gotoData.length);
            console.log('å¾Œè—¤ã•ã‚“ã®ã‚µãƒ³ãƒ—ãƒ«:', gotoData.slice(0, 5));
        }

        function createSummary() {
            const userSummary = {};
            const monthSummary = {};
            const categorySummary = {};
            const titleSummary = {};
            const orderTypeSummary = {};

            processedData.forEach(item => {
                if (!userSummary[item.applicant]) {
                    userSummary[item.applicant] = { 
                        total: 0, 
                        months: {}, 
                        categories: {}, 
                        titles: {}, 
                        orderTypes: {} 
                    };
                }
                userSummary[item.applicant].total += item.amount;

                if (!userSummary[item.applicant].months[item.month]) {
                    userSummary[item.applicant].months[item.month] = 0;
                }
                userSummary[item.applicant].months[item.month] += item.amount;

                if (!userSummary[item.applicant].categories[item.summary]) {
                    userSummary[item.applicant].categories[item.summary] = 0;
                }
                userSummary[item.applicant].categories[item.summary] += item.amount;

                if (!userSummary[item.applicant].titles[item.title]) {
                    userSummary[item.applicant].titles[item.title] = 0;
                }
                userSummary[item.applicant].titles[item.title] += item.amount;

                if (!userSummary[item.applicant].orderTypes[item.orderType]) {
                    userSummary[item.applicant].orderTypes[item.orderType] = 0;
                }
                userSummary[item.applicant].orderTypes[item.orderType] += item.amount;

                if (!monthSummary[item.month]) {
                    monthSummary[item.month] = 0;
                }
                monthSummary[item.month] += item.amount;

                if (!categorySummary[item.summary]) {
                    categorySummary[item.summary] = 0;
                }
                categorySummary[item.summary] += item.amount;

                if (!titleSummary[item.title]) {
                    titleSummary[item.title] = 0;
                }
                titleSummary[item.title] += item.amount;

                if (!orderTypeSummary[item.orderType]) {
                    orderTypeSummary[item.orderType] = 0;
                }
                orderTypeSummary[item.orderType] += item.amount;
            });

            summary = {
                users: userSummary,
                months: monthSummary,
                categories: categorySummary,
                titles: titleSummary,
                orderTypes: orderTypeSummary,
                totalAmount: processedData.reduce((sum, item) => sum + item.amount, 0),
                totalCount: processedData.length
            };

            // ãƒ‡ãƒãƒƒã‚°: å¾Œè—¤ã•ã‚“ã®é›†è¨ˆçµæœã‚’ç¢ºèª
            console.log('å¾Œè—¤ã•ã‚“ã®é›†è¨ˆçµæœ:', summary.users['å¾Œè—¤ã€€å’Œå…¸']);
        }

        function updateDisplay() {
            updateSummaryCards();
            updateQuotaSection();
            updateIndividualSection();
            updateFilters();
            updateCharts();
            updateDataTable();
        }

        function updateSummaryCards() {
            // ãƒ‡ã‚¸ãƒ©ãƒœå®Ÿç¸¾ã®æ­£ã—ã„è¨ˆç®—ï¼ˆé–‹ç™ºæ¡ˆä»¶ã‚’ãƒã‚¤ãƒŠã‚¹ï¼‰
            const digitalLabAmount = summary.totalAmount - (summary.orderTypes['é–‹ç™º'] || 0);
            
            document.getElementById('totalAmount').textContent = 'Â¥' + summary.totalAmount.toLocaleString();
            document.getElementById('totalCount').textContent = summary.totalCount + 'ä»¶';
            document.getElementById('userCount').textContent = Object.keys(summary.users).length + 'å';
            document.getElementById('externalAmount').textContent = 'Â¥' + (summary.orderTypes['å¤–éƒ¨ç™ºæ³¨'] || 0).toLocaleString();
            document.getElementById('digitalLabAmount').textContent = 'Â¥' + digitalLabAmount.toLocaleString();
            document.getElementById('digitalLabAverage').textContent = 'æœˆå¹³å‡: Â¥' + Math.round(digitalLabAmount / 4).toLocaleString();
        }

        function calculateDigitalLabMonthly() {
            const months = ['2025å¹´4æœˆ', '2025å¹´5æœˆ', '2025å¹´6æœˆ', '2025å¹´7æœˆ'];
            return months.map(month => {
                // æœˆåˆ¥ã®å…¨ä½“é‡‘é¡ã‚’è¨ˆç®—
                let monthAmount = summary.months[month] || 0;
                
                // é–‹ç™ºæ¡ˆä»¶ã‚’æœˆåˆ¥ã§å·®ã—å¼•ã
                const developmentAmountInMonth = processedData
                    .filter(item => item.month === month && item.orderType === 'é–‹ç™º')
                    .reduce((sum, item) => sum + item.amount, 0);
                
                monthAmount -= developmentAmountInMonth;
                
                const achievementRate = (monthAmount / MONTHLY_QUOTA) * 100;
                return {
                    month: month,
                    amount: monthAmount,
                    quota: MONTHLY_QUOTA,
                    achievementRate: achievementRate,
                    difference: monthAmount - MONTHLY_QUOTA
                };
            });
        }

        function updateQuotaSection() {
            const digitalLabMonthly = calculateDigitalLabMonthly();
            const quotaGrid = document.getElementById('quotaGrid');
            quotaGrid.innerHTML = '';

            digitalLabMonthly.forEach(monthData => {
                const card = document.createElement('div');
                card.className = 'quota-card';
                
                const progressClass = monthData.achievementRate >= 100 ? 'progress-green' : 
                                    monthData.achievementRate >= 80 ? 'progress-yellow' : 'progress-red';
                const statusIcon = monthData.achievementRate >= 100 ? 'âœ…' : 
                                 monthData.achievementRate >= 80 ? 'âš ï¸' : 'âŒ';

                card.innerHTML = `
                    <h4>${monthData.month}</h4>
                    <div style="font-size: 18px; font-weight: bold; color: #007bff; margin-bottom: 10px;">
                        Â¥${monthData.amount.toLocaleString()}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ãƒãƒ«ãƒ: Â¥${monthData.quota.toLocaleString()}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${Math.min(monthData.achievementRate, 100)}%"></div>
                    </div>
                    <div style="font-weight: bold; margin-top: 5px;">
                        ${monthData.achievementRate.toFixed(1)}% ${statusIcon}
                    </div>
                    <div style="font-size: 12px; margin-top: 5px; color: ${monthData.difference >= 0 ? '#28a745' : '#dc3545'};">
                        ${monthData.difference >= 0 ? '+' : ''}Â¥${monthData.difference.toLocaleString()}
                    </div>
                `;
                quotaGrid.appendChild(card);
            });

            const totalDigitalLab = summary.totalAmount - (summary.orderTypes['é–‹ç™º'] || 0);
            const overallRate = (totalDigitalLab / (MONTHLY_QUOTA * 4)) * 100;
            
            document.getElementById('totalDigitalLab').textContent = 'Â¥' + totalDigitalLab.toLocaleString();
            document.getElementById('overallAchievement').textContent = overallRate.toFixed(1) + '%';
            
            const overallElement = document.getElementById('overallAchievement');
            overallElement.style.color = overallRate >= 100 ? '#28a745' : overallRate >= 80 ? '#ffc107' : '#dc3545';
        }

        function updateIndividualSection() {
            const individualGrid = document.getElementById('individualGrid');
            individualGrid.innerHTML = '';

            Object.keys(INDIVIDUAL_TARGETS).forEach(name => {
                const target = INDIVIDUAL_TARGETS[name];
                const userData = summary.users[name] || { total: 0, months: {}, orderTypes: {} };
                
                const card = document.createElement('div');
                card.className = 'individual-card';
                
                // é–‹ç™ºæ¡ˆä»¶ã‚’ãƒã‚¤ãƒŠã‚¹ã—ã¦è¨ˆç®—
                const totalAmount = userData.total - (userData.orderTypes['é–‹ç™º'] || 0);
                const monthlyAverage = totalAmount / 4;
                const achievementRate = (monthlyAverage / target) * 100;
                
                const months = ['2025å¹´4æœˆ', '2025å¹´5æœˆ', '2025å¹´6æœˆ', '2025å¹´7æœˆ'];
                let monthsHtml = '';
                
                months.forEach(month => {
                    // æœˆåˆ¥ã®é–‹ç™ºæ¡ˆä»¶ã‚’å·®ã—å¼•ã
                    const monthAmount = userData.months[month] || 0;
                    const developmentInMonth = processedData
                        .filter(item => item.applicant === name && item.month === month && item.orderType === 'é–‹ç™º')
                        .reduce((sum, item) => sum + item.amount, 0);
                    
                    const adjustedMonthAmount = monthAmount - developmentInMonth;
                    const monthRate = (adjustedMonthAmount / target) * 100;
                    const monthProgressClass = monthRate >= 100 ? 'progress-green' : 
                                             monthRate >= 80 ? 'progress-yellow' : 'progress-red';
                    
                    monthsHtml += `
                        <div class="month-detail">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                <span style="font-weight: bold;">${month}</span>
                                <span>Â¥${adjustedMonthAmount.toLocaleString()}</span>
                            </div>
                            <div class="month-progress">
                                <div class="progress-fill ${monthProgressClass}" style="width: ${Math.min(monthRate, 100)}%"></div>
                            </div>
                            <div style="font-size: 10px; color: #666;">
                                ${monthRate.toFixed(1)}% (ç›®æ¨™: Â¥${target.toLocaleString()})
                            </div>
                        </div>
                    `;
                });

                const overallProgressClass = achievementRate >= 100 ? 'progress-green' : 
                                           achievementRate >= 80 ? 'progress-yellow' : 'progress-red';

                card.innerHTML = `
                    <h4>${name}</h4>
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: bold; color: #007bff;">
                            ç·é¡: Â¥${totalAmount.toLocaleString()}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            æœˆå¹³å‡: Â¥${monthlyAverage.toLocaleString()} (${achievementRate.toFixed(1)}%)
                        </div>
                        <div class="progress-bar" style="margin: 10px 0;">
                            <div class="progress-fill ${overallProgressClass}" style="width: ${Math.min(achievementRate, 100)}%"></div>
                        </div>
                    </div>
                    ${monthsHtml}
                `;
                
                individualGrid.appendChild(card);
            });
        }

        function updateFilters() {
            updateFilterOptions('userFilter', Object.keys(summary.users), 'å…¨å“¡');
            updateFilterOptions('monthFilter', Object.keys(summary.months), 'å…¨æœˆ');
            updateFilterOptions('titleFilter', Object.keys(summary.titles), 'å…¨ã‚¿ã‚¤ãƒˆãƒ«');
            updateFilterOptions('orderTypeFilter', Object.keys(summary.orderTypes), 'å…¨åŒºåˆ†');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            ['userFilter', 'monthFilter', 'titleFilter', 'orderTypeFilter'].forEach(filterId => {
                document.getElementById(filterId).addEventListener('change', applyFilters);
            });
        }

        function updateFilterOptions(filterId, options, defaultOption) {
            const select = document.getElementById(filterId);
            const currentValue = select.value;
            
            select.innerHTML = `<option value="${defaultOption}">${defaultOption}</option>`;
            
            options.sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function applyFilters() {
            const userFilter = document.getElementById('userFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const titleFilter = document.getElementById('titleFilter').value;
            const orderTypeFilter = document.getElementById('orderTypeFilter').value;

            filteredData = processedData.filter(item => {
                return (userFilter === 'å…¨å“¡' || item.applicant === userFilter) &&
                       (monthFilter === 'å…¨æœˆ' || item.month === monthFilter) &&
                       (titleFilter === 'å…¨ã‚¿ã‚¤ãƒˆãƒ«' || item.title === titleFilter) &&
                       (orderTypeFilter === 'å…¨åŒºåˆ†' || item.orderType === orderTypeFilter);
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã«ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã™
            currentPage = 1;
            updateChartsWithFilteredData(filteredData);
            updateDataTableWithFilteredData(filteredData);
        }

        function updateCharts() {
            updateChartsWithFilteredData(processedData);
        }

        function updateChartsWithFilteredData(data) {
            // æ£’ã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆé–‹ç™ºæ¡ˆä»¶ã‚’ãƒã‚¤ãƒŠã‚¹è¨ˆç®—ï¼‰
            const userAmounts = {};
            data.forEach(item => {
                if (!userAmounts[item.applicant]) {
                    userAmounts[item.applicant] = 0;
                }
                if (item.orderType === 'é–‹ç™º') {
                    userAmounts[item.applicant] -= item.amount;
                } else {
                    userAmounts[item.applicant] += item.amount;
                }
            });

            const sortedUsers = Object.entries(userAmounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            // å††ã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
            const orderTypeAmounts = {};
            data.forEach(item => {
                if (!orderTypeAmounts[item.orderType]) {
                    orderTypeAmounts[item.orderType] = 0;
                }
                orderTypeAmounts[item.orderType] += item.amount;
            });

            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (barChart) {
                barChart.destroy();
            }
            if (pieChart) {
                pieChart.destroy();
            }

            // æ£’ã‚°ãƒ©ãƒ•ä½œæˆ
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: sortedUsers.map(([user]) => user),
                    datasets: [{
                        label: 'é‡‘é¡',
                        data: sortedUsers.map(([, amount]) => amount),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Â¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // å††ã‚°ãƒ©ãƒ•ä½œæˆ
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];

            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(orderTypeAmounts),
                    datasets: [{
                        data: Object.values(orderTypeAmounts),
                        backgroundColor: colors.slice(0, Object.keys(orderTypeAmounts).length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': Â¥' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDataTable() {
            filteredData = processedData; // åˆæœŸåŒ–æ™‚ã¯å…¨ãƒ‡ãƒ¼ã‚¿
            currentPage = 1;
            updateDataTableWithFilteredData(filteredData);
        }

        function updateDataTableWithFilteredData(data) {
            const tbody = document.getElementById('dataTableBody');
            const tableInfo = document.getElementById('tableInfo');
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ•°ã®æ›´æ–°
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            totalPages = Math.ceil(data.length / itemsPerPage);
            
            // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageData = data.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            currentPageData.forEach(item => {
                const row = document.createElement('tr');
                
                const dateStr = item.date ? item.date.toLocaleDateString('ja-JP') : '';
                const amountClass = item.orderType === 'å¤–éƒ¨ç™ºæ³¨' ? 'text-red' : '';
                const orderTypeClass = item.orderType === 'å¤–éƒ¨ç™ºæ³¨' ? 'text-red' : '';
                
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${item.applicant}</td>
                    <td class="${amountClass}">Â¥${item.amount.toLocaleString()}</td>
                    <td>${item.summary}</td>
                    <td>${item.title}</td>
                    <td class="${orderTypeClass}">${item.orderType}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®æ›´æ–°
            updatePaginationInfo(data.length);
            
            tableInfo.textContent = `å…¨${data.length}ä»¶ä¸­ ${startIndex + 1}-${Math.min(endIndex, data.length)}ä»¶ã‚’è¡¨ç¤º`;
        }

        function updatePaginationInfo(totalItems) {
            const pageInfo = document.getElementById('pageInfo');
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            pageInfo.textContent = `${currentPage} / ${totalPages}ãƒšãƒ¼ã‚¸`;
            
            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹
            firstPageBtn.disabled = prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = lastPageBtn.disabled = currentPage === totalPages;
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®è¡¨ç¤º/éè¡¨ç¤º
            document.getElementById('pagination').style.display = totalPages <= 1 ? 'none' : 'flex';
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateDataTableWithFilteredData(filteredData);
        }

        // è¡¨ç¤ºä»¶æ•°å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('itemsPerPage').addEventListener('change', function() {
                currentPage = 1; // ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã™
                updateDataTableWithFilteredData(filteredData);
            });
        });

        // UI ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            hideSuccess();
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            hideError();
            setTimeout(() => {
                hideSuccess();
            }, 5000);
        }

        function hideSuccess() {
            document.getElementById('success').style.display = 'none';
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>